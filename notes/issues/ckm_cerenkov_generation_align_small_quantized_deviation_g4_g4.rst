ckm_cerenkov_generation_align_small_quantized_deviation_g4_g4
================================================================

* context :doc:`ckm_cerenkov_generation_align`

::

   ckm--        
       G4 example style CerenkovMinimal, with Opticks embedded via G4OK, 
       collecting gensteps 

       * bi-simulation, OK using bouncemax 0 making ox.npy comparable with so.npy  

   ckm-gentest
       CCerenkovGenerationTest generating G4 Cerenkov process style generation 
       of Cerenkov photons from the gensteps. The photons are collected with 
       C4PhotonCollector::collectSecondaryPhotons

       * mono-simulation "G4" only 

   ckm-so 
       compare the photons from the above two 



G4-G4 deviations of genstep 0 at 1e-5 level 
---------------------------------------------

* potentially this is fixable : as almost the same code ??? 


::

    epsilon:1 blyth$ ckm-so
    # source/evt/g4live/natural/-1/so.npy tests/CCerenkovGeneratorTest/so.npy
    import numpy as np, commands

    apath = "source/evt/g4live/natural/-1/so.npy"
    bpath = "tests/CCerenkovGeneratorTest/so.npy"

    print " ckm-xx- comparing so.npy and so.npy between two dirs " 

    print "  ", commands.getoutput("date")
    print "a ", commands.getoutput("ls -l %s" % apath)
    print "b ", commands.getoutput("ls -l %s" % bpath)

    a = np.load(apath)
    b = np.load(bpath)

    print "a %s " % repr(a.shape)
    print "b %s " % repr(b.shape)

    dv = np.max( np.abs(a[:,:3]-b[:,:3]), axis=(1,2) )

    cut = 1e-5
    wh = np.where( dv > cut )[0] 
    print " deviations above cut %s wh %s num_wh %d" % ( cut, repr(wh), len(wh) )
    for i in wh:
        print i, dv[i], "\n",np.hstack([a[i,:3],(a[i,:3]-b[i,:3])/cut,b[i,:3]])


    args: /opt/local/bin/ipython -i /tmp/blyth/opticks/ckm/ckm-so.py
     ckm-xx- comparing so.npy and so.npy between two dirs 
       Sat Sep  8 16:36:48 CST 2018
    a  -rw-r--r--  1 blyth  staff  14224 Sep  8 15:09 source/evt/g4live/natural/-1/so.npy
    b  -rw-r--r--  1 blyth  staff  14224 Sep  8 16:02 tests/CCerenkovGeneratorTest/so.npy
    a (221, 4, 4) 
    b (221, 4, 4) 
     deviations above cut 1e-05 wh array([ 11,  20,  23,  30,  37,  81,  91, 106, 116, 129, 149, 153, 157, 168, 175, 195, 217]) num_wh 17
    11 1.5258789e-05 
    [[  0.3261  -0.0653  -0.0131   0.0012   0.003    0.       0.      -0.033    0.3261  -0.0653  -0.0131   0.0012]
     [  0.8373   0.1958  -0.5104   1.       0.       0.0015   0.       0.       0.8373   0.1958  -0.5104   1.    ]
     [ -0.5159   0.5917  -0.6194 173.2261  -0.006    0.       0.      -1.5259  -0.5159   0.5917  -0.6194 173.2261]]
    20 1.5258789e-05 
    [[  0.1764  -0.0353  -0.0071   0.0007   0.       0.       0.      -0.1668   0.1764  -0.0353  -0.0071   0.0007]
     [  0.824   -0.0863   0.56     1.       0.       0.0015   0.006    0.       0.824   -0.0863   0.56     1.    ]
     [ -0.5339   0.2129   0.8183 225.6083   0.      -0.0015   0.      -1.5259  -0.5339   0.2129   0.8183 225.6083]]



Largest deviations by far in wavelength exhibit quantization, I've seen that before several times.
Potentially rearranging the calc (suspect the h_Planck*c_light) can avoid the loss of precision.
Or switching some wavelength calculations from floats to doubles might avoid the discrepancy::

    :set nowrap

    In [2]: a[:,2,3]
    Out[2]: 
    array([ 79.0277,  64.7407, 548.7668,  61.7771,  64.4733, 123.2384,  86.7476, 342.7441, 117.8821, 109.3267,  75.7048, 173.2261,  81.6398, 147.9871,  85.1391, 174.5106, 162.5099,  72.7494, 277.77  ,
           123.5169, 225.6083,  93.8313, 167.6152, 130.9077, 206.6848,  67.5551,  89.2702,  64.3895,  98.4576, 102.3028, 148.9391,  80.7324, 181.2109,  92.7293,  97.1287, 142.5959, 202.6614, 131.1252,
           374.9776,  90.9865, 177.908 ,  75.4274, 221.5182, 131.5636, 579.5532, 105.2722,  80.8811, 149.3335, 195.2076,  60.8645,  64.805 , 243.2596, 248.062 ,  95.5747,  82.2436, 534.6089,  79.9717,
            63.5332,  70.2041,  93.7485, 186.9358, 648.9679,  70.976 ,  80.8478,  94.1366,  91.3074, 106.3398,  72.6019, 468.2738, 115.8758,  60.5063,  67.5606,  60.0227, 226.574 , 125.4183, 143.3505,
           123.1239, 204.5349, 570.6711,  79.9497, 112.9581, 169.4574,  72.8764, 310.8695,  75.0887, 425.5308, 319.5373, 214.4684,  78.8575,  91.6571, 279.3283, 712.3975, 257.3839, 116.1608,  73.2316,
            84.4979, 169.8288,  73.015 , 133.1829,  77.9709, 273.4775, 100.1011,  62.8888, 122.4117,  60.9665,  60.5976, 437.5226,  73.6779,  93.8359, 162.9223,  69.3967, 308.0741, 206.8569, 281.0906,
           354.0475,  70.9378, 216.0976,  69.1427,  71.2186, 395.1858,  72.5484,  62.245 ,  64.9126,  62.8659,  67.1596, 122.2048, 243.1878,  99.848 , 281.5753, 229.8984, 102.4251, 111.8704,  89.9378,
            96.5338, 387.9238,  88.474 , 418.489 ,  60.7484, 337.4237,  86.13  , 169.2958, 173.2219,  90.8782, 100.5663, 102.6608,  76.9098, 130.5398,  73.0516, 276.8902, 669.2324, 129.1481, 178.1693,
            80.4022, 148.645 ,  82.2096, 180.9816, 478.1989, 347.0385, 701.7363, 307.0316,  98.3666,  68.2406, 117.2317, 118.3642, 250.1153, 307.9542, 109.4113,  93.5827, 156.5334, 141.4091, 102.7313,
           116.6907,  79.3124,  66.3532,  90.0335, 138.0788, 102.4005,  72.3957,  91.2472,  66.1942,  75.7314,  62.9483, 100.5314,  61.2778, 320.2833, 113.136 , 125.5672, 123.0379,  73.3235,  60.7833,
            64.9003,  65.0813, 186.2178,  97.9955,  94.4072, 249.8319,  63.7631,  63.26  , 250.7668, 105.0116,  64.8669, 159.1434,  82.9787,  63.0955,  81.6907,  60.3963, 112.7277,  93.8711, 133.5138,
            71.7063,  70.6572, 268.3157,  77.3328,  87.9134, 254.3371, 501.4822,  93.0721, 192.1853,  72.5816, 135.4417, 332.5084], dtype=float32)

    In [3]: b[:,2,3]
    Out[3]: 
    array([ 79.0277,  64.7407, 548.7668,  61.7771,  64.4733, 123.2384,  86.7476, 342.7441, 117.8821, 109.3267,  75.7048, 173.2261,  81.6398, 147.9871,  85.1391, 174.5106, 162.5099,  72.7494, 277.77  ,
           123.5169, 225.6083,  93.8313, 167.6152, 130.9077, 206.6848,  67.5551,  89.2702,  64.3895,  98.4576, 102.3028, 148.9391,  80.7324, 181.2109,  92.7293,  97.1287, 142.5959, 202.6614, 131.1252,
           374.9776,  90.9865, 177.908 ,  75.4274, 221.5182, 131.5636, 579.5532, 105.2722,  80.8811, 149.3335, 195.2076,  60.8645,  64.805 , 243.2596, 248.062 ,  95.5747,  82.2436, 534.6089,  79.9717,
            63.5332,  70.2041,  93.7485, 186.9358, 648.9679,  70.976 ,  80.8478,  94.1366,  91.3074, 106.3398,  72.6019, 468.2738, 115.8758,  60.5063,  67.5606,  60.0227, 226.574 , 125.4183, 143.3505,
           123.1239, 204.5349, 570.6711,  79.9497, 112.9581, 169.4574,  72.8764, 310.8695,  75.0887, 425.5308, 319.5373, 214.4684,  78.8575,  91.6571, 279.3283, 712.3975, 257.3839, 116.1608,  73.2316,
            84.4979, 169.8288,  73.015 , 133.1829,  77.9709, 273.4775, 100.1011,  62.8888, 122.4117,  60.9665,  60.5976, 437.5226,  73.678 ,  93.8359, 162.9223,  69.3968, 308.0741, 206.8569, 281.0906,
           354.0475,  70.9378, 216.0977,  69.1427,  71.2186, 395.1858,  72.5484,  62.245 ,  64.9126,  62.8659,  67.1596, 122.2048, 243.1878,  99.848 , 281.5753, 229.8984, 102.4251, 111.8704,  89.9378,
            96.5338, 387.9238,  88.474 , 418.489 ,  60.7484, 337.4237,  86.13  , 169.2958, 173.2219,  90.8782, 100.5664, 102.6608,  76.9098, 130.5398,  73.0516, 276.8902, 669.2323, 129.1481, 178.1693,
            80.4022, 148.645 ,  82.2096, 180.9816, 478.1989, 347.0385, 701.7363, 307.0316,  98.3666,  68.2406, 117.2317, 118.3642, 250.1153, 307.9542, 109.4113,  93.5827, 156.5334, 141.4091, 102.7313,
           116.6907,  79.3124,  66.3532,  90.0335, 138.0789, 102.4005,  72.3957,  91.2472,  66.1942,  75.7314,  62.9483, 100.5314,  61.2778, 320.2833, 113.136 , 125.5672, 123.0379,  73.3235,  60.7833,
            64.9003,  65.0813, 186.2178,  97.9955,  94.4072, 249.8319,  63.7631,  63.26  , 250.7668, 105.0116,  64.8669, 159.1434,  82.9787,  63.0955,  81.6907,  60.3963, 112.7277,  93.8711, 133.5138,
            71.7063,  70.6572, 268.3157,  77.3328,  87.9134, 254.3371, 501.4822,  93.0721, 192.1853,  72.5816, 135.4417, 332.5084], dtype=float32)

    In [4]: a[:,2,3]-b[:,2,3]
    Out[4]: 
    array([ 0.    ,  0.    ,  0.    , -0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,
           -0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    , -0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.0001,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    , -0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,
           -0.    , -0.    , -0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,
            0.    , -0.    ,  0.    , -0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    , -0.    ,  0.    , -0.    ,  0.    , -0.    ,  0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.0001,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    , -0.    ,  0.    ,
           -0.    ,  0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    , -0.    ,  0.    , -0.    ,  0.    , -0.    , -0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    , -0.    , -0.    , -0.    ,  0.    ,  0.    ,
           -0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.    ,  0.    ,  0.    ,  0.    ], dtype=float32)

    In [5]: 1e6*(a[:,2,3]-b[:,2,3])
    Out[5]: 
    array([  0.    ,   0.    ,   0.    ,  -3.8147,   0.    ,  -7.6294,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    , -15.2588,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
             0.    , -15.2588,  -7.6294,   0.    , -15.2588,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,  -7.6294, -15.2588,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    ,   0.    , -15.2588,
             0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,   0.    ,
             0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    ,  -3.8147,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,
             0.    ,   0.    ,   0.    ,   0.    ,  -7.6294, -15.2588,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,  61.0352,   0.    ,   0.    ,   0.    ,
             0.    ,   0.    ,  -7.6294,   0.    ,  -7.6294,   0.    ,   0.    ,  -3.8147,   0.    ,   0.    ,  -3.8147, -30.5176,  -7.6294,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,   0.    ,
             0.    ,   0.    , -15.2588,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  -3.8147,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    , -15.2588,   0.    ,  -7.6294,  -7.6294,
             0.    ,   0.    ,  -7.6294,   0.    ,  -3.8147,   0.    ,  -7.6294,   0.    ,   0.    ,  -7.6294,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  61.0352,   0.    ,   0.    ,
             0.    , -15.2588,   0.    ,   0.    ,   0.    , -30.5176,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,  -7.6294,   0.    , -15.2588,   0.    ,  -7.6294,
            -7.6294,   0.    ,   0.    ,   0.    , -15.2588,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,  -3.8147,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
             0.    ,  -7.6294,   0.    ,  -7.6294,   0.    , -15.2588,  -3.8147,  -3.8147,   0.    ,   0.    ,   0.    ,   0.    ,  -7.6294,   0.    ,   0.    ,  -3.8147,  -7.6294,  -7.6294,   0.    ,
             0.    ,  -7.6294,   0.    ,  -7.6294,   0.    ,   0.    ,   0.    ,   0.    , -15.2588,   0.    ,   0.    ,   0.    ], dtype=float32)

    In [6]: -7.6294*2
    Out[6]: -15.2588

    In [7]: -3.8147*2
    Out[7]: -7.6294



::

        kineticEnergy/eV,        // temporary switch from weight 



Fractional deviation in the energy::

    In [19]: 1e6*(a[:,1,3] - b[:,1,3])/a[:,1,3]
    Out[19]: 
    array([ 0.    ,  0.    ,  0.    ,  0.095 ,  0.0992,  0.0948,  0.    ,  0.    ,  0.0907,  0.    ,  0.    ,  0.    ,  0.0628,  0.    ,  0.0655,  0.    ,  0.    ,  0.1119,  0.1068,  0.    ,  0.0868,
            0.0722,  0.    ,  0.    ,  0.    ,  0.    ,  0.0687,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0713,  0.    ,  0.    ,  0.0779,  0.    ,  0.    ,  0.07  ,  0.    ,  0.    ,
            0.0852,  0.    ,  0.    ,  0.    ,  0.0622,  0.1149,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0633,  0.    ,  0.0615,  0.    ,  0.108 ,  0.0721,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.0702,  0.    ,  0.    ,  0.    ,  0.0891,  0.    ,  0.    ,  0.0923,  0.    ,  0.    ,  0.    ,  0.0947,  0.0787, -0.1097,  0.    ,  0.    ,  0.0652,  0.    ,  0.    ,
            0.    ,  0.    ,  0.0614,  0.    ,  0.0607,  0.    ,  0.1074,  0.    ,  0.099 ,  0.    ,  0.    ,  0.065 ,  0.0653,  0.    ,  0.    ,  0.    ,  0.    ,  0.077 ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.1133,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.1081,  0.    ,  0.1091,  0.    ,  0.    ,  0.    ,  0.076 ,  0.    ,  0.    ,  0.0999,  0.0967,  0.    ,  0.    ,
            0.    ,  0.    ,  0.    ,  0.0884,  0.0788,  0.086 ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0666,  0.    ,  0.    ,  0.079 ,  0.    ,  0.    ,
            0.1124,  0.    ,  0.    ,  0.    ,  0.0685,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    , -0.0675,  0.    ,  0.0757,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.0602,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.1114,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0943,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.0935,  0.    ,  0.1001,  0.    ,  0.0754,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0612,  0.0638,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,
            0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.    ,  0.0716,  0.0739,  0.1117,  0.    ,  0.    ], dtype=float32)


Pmin and dp=Pmax-Pmin are in MeV so small 10-5 level numbers::

    276          sampledEnergy = Pmin + rand * dp;             


A difference between the two is that for the generation from gensteps the 
params are persisted as floats during travel.  Perhaps should redefine the gensteps 
such that energies travel as eV rather that the default MeV  ?

::

    150     G4double Pmin = q4.y ;
    151     G4double Pmax = q4.z ;
    152 
    153     G4double wavelength_min = h_Planck*c_light/Pmax ;
    154     G4double wavelength_max = h_Planck*c_light/Pmin ;
    155 
    156     //G4double maxCos = q4.w ;
    157 
    158     LOG(info)
    159         << " Pmin " << Pmin
    160         << " Pmax " << Pmax
    161         << " wavelength_min(nm) " << wavelength_min/nm
    162         << " wavelength_max(nm) " << wavelength_max/nm
    163         << " meanVelocity " << meanVelocity
    164         ;
    165 
    166     G4double maxSin2 = q5.x ;
    167     G4double MeanNumberOfPhotons1 = q5.y ;
    168     G4double MeanNumberOfPhotons2 = q5.z ;
    169     G4double zero = q5.w ;
    170     G4double epsilon = 1e-6 ;
    171     assert( std::abs(zero) < epsilon ) ;     // caution with mixed buffers
    172     // am i storing a int in there, get a very small number ?
    173 
    174     G4double dp = Pmax - Pmin;




Avoiding use of the float constrained dp param from gensteps knocks the deviations
down an order of magnitude to 1e-6 level rather than 1e-5

* TODO: this fix is not possible on GPU : so see if having the energies travel as eV rather 
  than MeV can avoid the precision loss too : which will work on GPU too

::

    096 G4VParticleChange* CCerenkovGenerator::GeneratePhotonsFromGenstep( const OpticksGenstep* gs, unsigned idx ) // static 
     97 {
     98     unsigned num_gs = gs->getNumGensteps();
     99     bool have_gs = idx < num_gs ;
    100 
    ...
    196     G4double Pmin2 = Rindex->GetMinLowEdgeEnergy();
    197     G4double Pmax2 = Rindex->GetMaxLowEdgeEnergy();
    198     G4double dp2 = Pmax2 - Pmin2;
    199 
    200     bool Pmin_match = std::abs( Pmin2 - Pmin ) < epsilon ;
    201     bool Pmax_match = std::abs( Pmax2 - Pmax ) < epsilon ;
    202   
    ...
    275       do {
    276          rand = G4UniformRand();
    277          //sampledEnergy = Pmin + rand * dp; 
    278          sampledEnergy = Pmin2 + rand * dp2 ;
    279          sampledRI = Rindex->Value(sampledEnergy);
    280          cosTheta = BetaInverse / sampledRI;
    281 




