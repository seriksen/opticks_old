OKX4Test_j1808_viz_csgskiplv
==============================

Context 
----------

* :doc:`OKX4Test_j1808_x4gen_csg_solids_survey`


Issue : j1808 poor viz, PMTs hidden in cylinders
-------------------------------------------------

PMTs are placed inside sMask_virtual(?) LV:22 for Geant4 
performance technicality which makes for poor viz

FIXED by implementing csgskiplv option
-----------------------------------------

Creating geocache with kludge skip of LV 22::

    geocache-j1808 () 
    { 
        opticksdata-;
        OKX4Test --gdmlpath $(opticksdata-j) --g4codegen --csgskiplv 22
    }


Viewing as normal::

    geocache-view () 
    { 
        OKTest --envkey --xanalytic
    }



Confirming that LV:22 sMask_virtual is culprit by inspection of g4codegen output
---------------------------------------------------------------------------------------

/home/blyth/local/opticks/geocache/OKX4Test_lWorld0x4bc2710_PV_g4live/g4ok_gltf/528f4cefdac670fffe846377973af10a/1/g4codegen/tests/x022.cc::


     26 // start portion generated by nnode::to_g4code 
     27 G4VSolid* make_solid()
     28 {
     29     double A[]= { -354.050000, 196.050000 }  ;       // z-plane position   
     30     double B[]= { 0.000000, 0.000000 }  ;            // inner radius
     31     double C[]= { 264.050000, 264.050000 }  ;        // outer radius 
     32     G4VSolid* a = new G4Polycone("sMask_virtual0x4c36e10", 0.000000, CLHEP::twopi, 2, A, B, C) ; // 0
     33     return a ;
     34 }


Comparing these dimensions to those from ana/x018_torus_hyperboloid_plt.py this (LV:22) 
is clearly the technical envelope.

Hmm this looks like Polycone abuse to me ?  

* Why use a 2-zplane polycone to describe a cylinder ?
* probably this is due to lazyness of avoiding to come up with a transform, which in turn is because
  G4 doesnt provide z ranges (like Opticks does) 


x021.cc::

     27 G4VSolid* make_solid()
     28 {
     29     G4VSolid* c = new G4Ellipsoid("PMT_20inch_pmt_solid_1_Ellipsoid0x4c3bc00", 254.001000, 254.001000, 184.001000, -184.001000, 184.001000) ; // 2
     30     G4VSolid* f = new G4Tubs("PMT_20inch_pmt_solid_2_Tube0x4c3bc90", 0.000000, 77.976532, 21.496235, 0.000000, CLHEP::twopi) ; // 3
     31     G4VSolid* h = new G4Torus("PMT_20inch_pmt_solid_2_Torus0x4c84bd0", 0.000000, 47.009000, 97.000000, -0.000175, CLHEP::twopi) ; // 3
     32 
     33     G4ThreeVector A(0.000000,0.000000,-21.486235);
     34     G4VSolid* e = new G4SubtractionSolid("PMT_20inch_pmt_solid_part20x4c84c70", f, h, NULL, A) ; // 2
     35 
     36     G4ThreeVector B(0.000000,0.000000,-197.513765);
     37     G4VSolid* b = new G4UnionSolid("PMT_20inch_pmt_solid_1_20x4c84f90", c, e, NULL, B) ; // 1
     38     G4VSolid* j = new G4Tubs("PMT_20inch_pmt_solid_3_EndTube0x4c84e60", 0.000000, 50.011000, 60.010500, 0.000000, CLHEP::twopi) ; // 1
     39 
     40     G4ThreeVector C(0.000000,0.000000,-279.000500);
     41     G4VSolid* a = new G4UnionSolid("PMT_20inch_pmt_solid0x4c81b40", b, j, NULL, C) ; // 0
     42     return a ;
     43 }
     44 // end portion generated by nnode::to_g4code 
     45 


FIXED by implementing csgskiplv option
------------------------------------------

How to temporarily skip LV:22 in the geometry conversion (both for OpenGL and OptiX geometry) ?

* implemented at GInstancer level 

Assuming inner and outer materials are the same it could also be skipped in the simulation, in principal at least.
Hmm clearly it should be the outer volume of the PMT assembly instance found by GInstancer.


Dumping the LV in each repeater::

    2018-10-19 14:48:46.835 INFO  [195637] [GInstancer::dumpMeshset@521]  numRepeats 5 numRidx 6
     ridx 1 ms 5 ( 23 24 25 26 27  ) 
     ridx 2 ms 6 ( 17 18 19 20 21 22  ) 
     ridx 3 ms 4 ( 4 5 6 7  ) 
     ridx 4 ms 1 ( 15  ) 
     ridx 5 ms 1 ( 16  ) 



idxBuffer.npy from geocache GParts/0 shows the LV of the global (non-instanced) volumes::

    In [8]: np.unique(i[:,1])
    Out[8]: 
    array([ 0,  1,  2,  3,  8,  9, 10, 11, 12, 13, 14, 28, 29, 30, 31, 32, 33,
           34, 35, 36, 37, 38, 39], dtype=uint32)



